# Python Project Developer Guidance

Python port for the Tableau Migration SDK

## First Steps

* Make sure the "Python" workload is installed for Visual Studio
* Install Python3 (and pip3) (make sure it's on PATH) and restart Visual Studio
  * It MUST be python3. To verify, start `python` and check the version. Python2 is very different.
* _Optional_: Update PIP and SetupTools to the latest version by executing `python -m pip install --upgrade pip setuptools`
  * PIP and SetupTools are the only pre-loaded modules on a clean Windows installation
* _Optional_ for hatch: Install pytest globally to run tests on Visual Studio
  * `python -m pip install --upgrade pytest pytest-env`
* Install hatch globally
  * `python -m pip install --upgrade hatch`
* Create the Python virtual environment
  * (From migration-sdk/src/Python): `python -m venv env --system-site-packages --upgrade-deps`
* _Optional_ for hatch: Activate the virtual environment to run tests on Visual Studio
  * `.\env\Scripts\Activate.ps1`
* _Optional_ for hatch: Install the required modules for run tests on the virtual environment to run tests on Visual Studio:
  * `python -m pip install -r .\requirements.txt`

## Linting

Linting is static code analysis. It's used a lot in Python to catch errors before the modules are run.

Linting is done as part of the CI/CD pipeline.

The linter we use is Ruff: <https://beta.ruff.rs/docs/>

Ruff has a VSCode extension which is nice to have. Visual Studio does not have an extension.

Visual Studio by default uses `pylint`, which lints a subset of `ruff``.

To run ruff locally:

* **Without hatch**:
  * Install ruff globally:
    * `python -m pip install ruff`.
    * **IMPORTANT**: Don't install it from inside a virtual environment.
  * Activate the virtual environment:
    * `.\env\Scripts\Activate.ps1`.
  * Execute linter:
    * `python -m ruff check --output-format=github .`.
* **With hatch**:
  * Execute linter:
    * `python -m hatch run lint:lint`.

## Documentation

The documentation is generated by using the package sphinx.

To generate the documentation locally:
* **Without hatch**:
  * Install sphinx globally:
    * `python -m pip install sphinx-markdown-builder`.
    * **IMPORTANT**: Don't install it from inside a virtual environment.
  * Activate the virtual environment:
    * `.\env\Scripts\Activate.ps1`.
  * Generate documentation:
    * `python -m sphinx -M markdown .\Documentation\ ..\Documentation\python\ -Q`.
* **With hatch**:
  * Generate documentation:
    * `python -m hatch run docs:docs`.

## Testing

### Prereqs

* Set `MIG_SDK_PYTHON_BUILD` env variable, else it won't build the dotnet binaries for the tests

All unit tests are located in the tests directory in the Python directory.

Visual Studio test runner should see the Python tests and be able to run them.

Python tests also run in the CI/CD pipeline on all supported OS types.

### To run tests manually

* **Without hatch**:
  * Activate the virtual environment:
    * `.\env\Scripts\Activate.ps1`.
  * Execute tests:
    * Execute the command `python -m pytest`.
  * _Optional_: if you want to generate the code coverage:
    * Install pytest-cov globally:
      * `python -m pip install pytest-cov`.
      * **IMPORTANT**: Don't install it from inside a virtual environment.
    * Activate the virtual environment:
      * `.\env\Scripts\Activate.ps1`.
    * Execute tests with coverage:
      * Execute the command `python -m pytest --cov-config=pyproject.toml --cov=tableau_migration`.
* **With hatch**:
  * Execute tests:
    * Execute the command `python -m hatch run test:test`.

### If things aren't working, try this

1. Verify the `MIG_SDK_PYTHON_BUILD` is set
1. open PowerShell to migration-sdk/src/Python
1. If you have not installed hatch, `pytest` - and check output
1. If you installed hatch, `hatch --version` - and check output

## Building and publishing

Overriding an existing package version is not supported.

This script will build the package and upload it to package repository. `scripts/publish-package.ps1`.

Use the flag **$SkipPublish** to disable the `python -m twine upload` if you don't want to upload.

To run manually the build process, execute the following commands:

* **Without hatch**:
  * Install build globally:
    * `python -m pip install build`.
    * **IMPORTANT**: Don't install it from inside a virtual environment.
  * Activate the virtual environment:
    * `.\env\Scripts\Activate.ps1`.
  * Build the wheel package: `python -m build --wheel`.
  * Build the source dist package: `python -m build --sdist`.
* **With hatch**:
  * Build the wheel and source dist packages: `python -m hatch build`.

## Freezing Requirements

Freezing is a process that ensures every developer runs the application locally using the correct versions of referred packages.

To generate frozen requirements, you must do the following:

* Activate the virtual environment
  * `.\env\Scripts\Activate.ps1`
* Execute the pip freeze command:
  * `python -m pip freeze --local > ./requirements.txt`

To import the requirements, you must do the following:

* Activate the virtual environment
  * `.\env\Scripts\Activate.ps1`
* Execute the pip install command:
  * `python -m pip install -r ./requirements.txt`

## Style Guide

Source: <https://www.python.org/dev/peps/pep-0008/#package-and-module-names>:

### Modules

Modules should have short, all-lowercase names. Underscores can be used in the module name if it improves readability. Python packages should also have short, all-lowercase names, although the use of underscores is discouraged.

### Classes

Class names should normally use the CapWords convention.

### Function and local variable names

Function and (local) variable names should be lowercase, with words separated by underscores as necessary to improve readability

### Difference between a module, class and package

* A Python module is simply a Python source file, which can expose classes, functions and global variables.
* A Python package is simply a directory of Python module(s).

### Summary of recommendations

Shamelessly borrowed from Google: <https://google.github.io/styleguide/pyguide.html#3164-guidelines-derived-from-guidos-recommendations>

| Type | Public | Internal |
|------|--------|----------|
Packages | lower_with_under
Modules | lower_with_under | _lower_with_under
Classes | CapWords | _CapWords
Exceptions | CapWords
Functions | lower_with_under() | _lower_with_under()
Global/Class Constants | CAPS_WITH_UNDER | _CAPS_WITH_UNDER
Global/Class Variables | lower_with_under | _lower_with_under
Instance Variables | lower_with_under | _lower_with_under (protected)
Method Names | lower_with_under() | _lower_with_under() (protected)
Function/Method Parameters | lower_with_under
Local Variables | lower_with_under
